# Gemini CLI 工具文档

本文档概述了 Gemini CLI 的主要组件，解释了它们的用途、关键方法和核心原理。

## 1. 交互式 CLI (`packages/cli/src/gemini.tsx`)

- **用途:** 这是交互式 Gemini CLI
  的主入口点。它负责初始化应用程序、加载配置和渲染用户界面。

- **主要方法:** `main()`

- **原理:**
  - **配置:** 应用程序启动时会从用户定义的文件（例如
    `.gemini/settings.json`）加载设置，并将其与命令行参数合并。这允许灵活的配置。
  - **环境设置:** 它会执行多项设置任务，例如检查系统内存并在需要时使用更优化的
    Node.js 内存设置重新启动。它还处理用于安全执行的沙盒环境的初始化。
  - **基于模式的执行:** CLI 可以在两种模式下运行：
    - **交互模式:** 如果它在没有直接输入的 TTY 中运行，它会使用 `ink`
      库启动一个基于 React 的终端用户界面 (TUI)。这提供了丰富的交互式体验。
    - **非交互模式:**
      如果通过管道将输入传递给它或作为参数提供，它会切换到非交互模式以直接执行命令。
  - **身份验证:** 它通过根据需要验证凭据和刷新令牌来管理身份验证，确保对 Gemini
    API 的安全访问。

## 2. 非交互式 CLI (`packages/cli/src/nonInteractiveCli.ts`)

- **用途:** 此组件处理 Gemini CLI 的非交互式执行，非常适合脚本编写和自动化。

- **主要方法:** `runNonInteractive(config: Config, input: string)`

- **原理:**
  - **命令循环:** 它在一个循环中运行，将用户输入发送到 Gemini API
    并处理响应。这允许多轮对话和后续命令。
  - **工具执行:** 一个关键特性是它能够处理工具调用。当 Gemini API
    返回执行工具的请求时，此组件会调用相应的工具，捕获其输出，并将结果发送回
    API。
  - **流式 I/O:** 它将 API
    的响应直接流式传输到标准输出，提供实时反馈。它还可以优雅地处理输出管道意外关闭的情况（例如，当管道连接到
    `head` 时）。
  - **错误处理:** 它包括强大的错误处理功能，可以捕获和报告来自 API
    和工具执行的问题，使其对于脚本来说是可靠的。

## 3. 沙盒 (`packages/cli/src/utils/sandbox.ts`)

- **用途:** 沙盒模块为运行 Gemini CLI
  及其工具提供了一个安全隔离的环境。这对于安全性以及确保工具不会对主机系统产生意外的副作用至关重要。

- **主要方法:** `start_sandbox(config: SandboxConfig, nodeArgs: string[] = [])`

- **原理:**
  - **多后端:** 它支持不同的沙盒技术：
    - **macOS Seatbelt:** 在 macOS 上，它可以使用内置的 `sandbox-exec`
      实用程序和预定义的安全配置文件（`.sb` 文件）来限制文件系统和网络访问。
    - **Docker/Podman:** 在其他系统上（或作为 macOS
      上的替代方案），它可以在容器内运行 CLI，提供高度的隔离。
  - **环境模拟:**
    使用容器时，它通过挂载当前目录、转发相关的环境变量（`PATH`、`PYTHONPATH`）和管理用户权限来仔细模拟用户的环境。这确保了
    CLI 的行为就像在本地运行一样。
  - **网络代理:**
    可以将其配置为通过代理路由来自沙盒的网络流量，这对于调试和在网络访问受限的环境中操作非常有用。
